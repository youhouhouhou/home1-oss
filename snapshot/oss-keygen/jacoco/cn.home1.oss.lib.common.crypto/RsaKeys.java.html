<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RsaKeys.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oss-keygen</a> &gt; <a href="index.source.html" class="el_package">cn.home1.oss.lib.common.crypto</a> &gt; <span class="el_source">RsaKeys.java</span></div><h1>RsaKeys.java</h1><pre class="source lang-java linenums">package cn.home1.oss.lib.common.crypto;

import static cn.home1.oss.lib.common.crypto.CryptoConstants.COLON;
import static cn.home1.oss.lib.common.crypto.RsaKey.KEY_FORMAT_PKCS1;
import static cn.home1.oss.lib.common.crypto.RsaKey.KEY_FORMAT_PKCS8;
import static cn.home1.oss.lib.common.crypto.RsaKey.KEY_FORMAT_PKCS8_X509;
import static cn.home1.oss.lib.common.crypto.RsaKey.KEY_FORMAT_X509;
import static cn.home1.oss.lib.common.crypto.RsaKey.KEY_TYPE_PAIR;
import static cn.home1.oss.lib.common.crypto.RsaKey.KEY_TYPE_PRIVATE;
import static cn.home1.oss.lib.common.crypto.RsaKey.KEY_TYPE_PUBLIC;
import static cn.home1.oss.lib.common.crypto.RsaKey.extractPrivateKey;
import static cn.home1.oss.lib.common.crypto.RsaKey.extractPublicKey;
import static cn.home1.oss.lib.common.crypto.RsaKey.keySize;
import static cn.home1.oss.lib.common.crypto.RsaKey.keySpec;
import static cn.home1.oss.lib.common.crypto.RsaKeyGenerator.pem;
import static java.nio.charset.StandardCharsets.US_ASCII;
import static lombok.AccessLevel.PRIVATE;
import static org.apache.commons.io.FileUtils.writeStringToFile;

import cn.home1.oss.lib.common.CodecUtils;

import lombok.NoArgsConstructor;
import lombok.SneakyThrows;

import java.io.File;

/**
 * Created by zhanghaolun on 16/11/13.
 */
<span class="nc" id="L30">@NoArgsConstructor(access = PRIVATE)</span>
public abstract class RsaKeys {

  public static String generateRsaKey(final int keySize) {
<span class="fc" id="L34">    final String spec = RsaKey.keySpec(KEY_FORMAT_PKCS8_X509, keySize, KEY_TYPE_PAIR);</span>
<span class="fc" id="L35">    final RsaKeyGenerator rsaKeyGenerator = new RsaKeyGenerator(spec);</span>
<span class="fc" id="L36">    final KeyExpression pairPkcs8X509 = rsaKeyGenerator.generateKey();</span>
<span class="fc" id="L37">    final KeyExpression pairPkcs1 = RsaKeyGenerator.convertPairFromPkcs8X509ToPkcs1(pairPkcs8X509);</span>

<span class="fc" id="L39">    final StringBuilder result = new StringBuilder();</span>
    //
<span class="fc" id="L41">    System.err.println(&quot;privateKey PKCS8: &quot; + writePemFile(pairPkcs8X509, KEY_FORMAT_PKCS8, KEY_TYPE_PRIVATE));</span>
<span class="fc" id="L42">    final String privateKeyPkcs1PemFile = writePemFile(pairPkcs1, KEY_FORMAT_PKCS1, KEY_TYPE_PRIVATE);</span>
<span class="fc" id="L43">    System.err.println(&quot;privateKey PKCS1: &quot; + privateKeyPkcs1PemFile);</span>
<span class="fc" id="L44">    System.err.println(&quot;Check with command line OpenSSL that the key format is as expected:&quot;);</span>
<span class="fc" id="L45">    System.err.println(&quot;openssl rsa -in &quot; + privateKeyPkcs1PemFile + &quot; -noout -text&quot;);</span>
    //
<span class="fc" id="L47">    System.err.println(&quot;publicKey  x509: &quot; + writePemFile(pairPkcs8X509, KEY_FORMAT_X509, KEY_TYPE_PUBLIC));</span>
<span class="fc" id="L48">    System.err.println(&quot;publicKey PKCS1: &quot; + writePemFile(pairPkcs1, KEY_FORMAT_PKCS1, KEY_TYPE_PUBLIC));</span>
    //
<span class="fc" id="L50">    return result //</span>
<span class="fc" id="L51">        .append(pairPkcs8X509.toString()).append(&quot;\n&quot;) //</span>
<span class="fc" id="L52">        .append(pairPkcs1.toString()).append(&quot;\n&quot;) //</span>
<span class="fc" id="L53">        .append(keySpec(KEY_TYPE_PRIVATE, keySize, KEY_FORMAT_PKCS1)).append(COLON) //</span>
<span class="fc" id="L54">        .append(extractPrivateKey(pairPkcs1)).append(&quot;\n&quot;) //</span>
<span class="fc" id="L55">        .append(keySpec(KEY_TYPE_PRIVATE, keySize, KEY_FORMAT_PKCS8)).append(COLON) //</span>
<span class="fc" id="L56">        .append(extractPrivateKey(pairPkcs8X509)).append(&quot;\n&quot;) //</span>
<span class="fc" id="L57">        .append(keySpec(KEY_TYPE_PUBLIC, keySize, KEY_FORMAT_PKCS1)).append(COLON) //</span>
<span class="fc" id="L58">        .append(extractPublicKey(pairPkcs1)).append(&quot;\n&quot;) //</span>
<span class="fc" id="L59">        .append(keySpec(KEY_TYPE_PUBLIC, keySize, KEY_FORMAT_X509)).append(COLON) //</span>
<span class="fc" id="L60">        .append(extractPublicKey(pairPkcs8X509)) //</span>
<span class="fc" id="L61">        .toString();</span>
  }

  public static File keyFile(final String keyFormat, final int keySize, final String keyType) {
    //final String targetDirectory = System.getProperty(&quot;java.io.tmpdir&quot;, &quot;/tmp&quot;);
<span class="fc" id="L66">    final String targetDirectory = System.getProperty(&quot;user.dir&quot;, &quot;/tmp&quot;);</span>
<span class="fc" id="L67">    return new File(targetDirectory + &quot;/&quot; + keySpec(keyType, keySize, keyFormat) + &quot;.pem&quot;);</span>
  }

<span class="nc" id="L70">  @SneakyThrows</span>
  public static String writePemFile(final KeyExpression pair, final String keyFormat, final String keyType) {
<span class="fc" id="L72">    final int keySize = keySize(pair.getSpec());</span>
<span class="fc" id="L73">    final File pemFile = keyFile(keyFormat, keySize, keyType);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">    final byte[] bytes = CodecUtils.decodeBase64(KEY_TYPE_PRIVATE.equals(keyType) ? //</span>
<span class="fc" id="L75">        extractPrivateKey(pair) : extractPublicKey(pair));</span>
<span class="fc" id="L76">    writeStringToFile(pemFile, pem(bytes, keyFormat, keyType), US_ASCII);</span>
<span class="fc" id="L77">    return pemFile.getPath();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>