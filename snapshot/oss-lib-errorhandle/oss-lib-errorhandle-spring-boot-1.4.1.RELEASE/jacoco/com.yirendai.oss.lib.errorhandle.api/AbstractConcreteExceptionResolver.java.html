<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractConcreteExceptionResolver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oss-lib-errorhandle-spring-boot-1.4.1.RELEASE</a> &gt; <a href="index.source.html" class="el_package">com.yirendai.oss.lib.errorhandle.api</a> &gt; <span class="el_source">AbstractConcreteExceptionResolver.java</span></div><h1>AbstractConcreteExceptionResolver.java</h1><pre class="source lang-java linenums">package com.yirendai.oss.lib.errorhandle.api;

import static com.google.common.base.Throwables.getStackTraceAsString;
import static com.google.common.collect.Lists.newArrayList;
import static com.yirendai.oss.lib.common.CurlUtils.curl;
import static com.yirendai.oss.lib.errorhandle.api.ResolvedErrorException.isResolvedError;
import static com.yirendai.oss.lib.errorhandle.api.ResolvedErrorException.isResolvedErrorWrapByOther;
import static org.springframework.web.context.request.RequestAttributes.SCOPE_REQUEST;
import static org.springframework.web.servlet.HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE;

import com.google.common.collect.ImmutableList;

import com.yirendai.oss.lib.common.Defaults;
import com.yirendai.oss.lib.errorhandle.api.ExceptionTranslator.Location;

import lombok.extern.slf4j.Slf4j;

import org.joda.time.DateTime;
import org.slf4j.Marker;
import org.slf4j.MarkerFactory;
import org.springframework.core.GenericTypeResolver;
import org.springframework.core.convert.ConversionService;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.util.Assert;
import org.springframework.web.context.request.RequestAttributes;
import org.springframework.web.context.request.ServletRequestAttributes;

import java.util.List;
import java.util.Optional;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;

/**
 * AbstractConcreteExceptionResolver.
 *
 * @param &lt;T&gt; exception type
 * @author zhanghaolun
 */
<span class="fc" id="L41">@Slf4j</span>
public abstract class AbstractConcreteExceptionResolver&lt;T extends Throwable&gt; implements ConcreteExceptionResolver&lt;T&gt; {

  private static final String TRACE_OFF = &quot;trace off&quot;;

  protected final Class&lt;T&gt; exceptionClass;

  protected ConversionService conversionService;
  protected ExceptionTranslator exceptionTranslator;
  protected StackTraceIndicator stackTraceIndicator;

  /**
   * This constructor determines the exception class from the generic class parameter {@code T}.
   */
<span class="fc" id="L55">  protected AbstractConcreteExceptionResolver() {</span>
<span class="fc" id="L56">    this.exceptionClass = determineTargetType();</span>
<span class="fc" id="L57">  }</span>

<span class="nc" id="L59">  protected AbstractConcreteExceptionResolver(final Class&lt;T&gt; exceptionClass) {</span>
<span class="nc" id="L60">    this.exceptionClass = exceptionClass;</span>
<span class="nc" id="L61">  }</span>

  @Deprecated
  static HttpStatus parseHttpStatus(final Object value) {
<span class="nc" id="L65">    Assert.notNull(value, &quot;Values of the resolverMap map must not be null&quot;);</span>

    final HttpStatus result;
<span class="nc bnc" id="L68" title="All 2 branches missed.">    if (value instanceof HttpStatus) {</span>
<span class="nc" id="L69">      result = (HttpStatus) value;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">    } else if (value instanceof Integer) {</span>
<span class="nc" id="L71">      result = HttpStatus.valueOf((int) value);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">    } else if (value instanceof String) {</span>
<span class="nc" id="L73">      result = HttpStatus.valueOf(Integer.parseInt((String) value));</span>
    } else {
<span class="nc" id="L75">      throw new IllegalArgumentException(String.format( //</span>
        &quot;Values of the resolverMap maps must be instance of &quot; //
          + &quot;ErrorResponseFactory, HttpStatus, String, or int, &quot; //
          + &quot;but %s given&quot;,
<span class="nc" id="L79">        value.getClass()));</span>
    }
<span class="nc" id="L81">    return result;</span>
  }

  @Deprecated
  @SuppressWarnings(&quot;unused&quot;)
  private static &lt;T extends Throwable&gt; Throwable cause(final T exception) {
<span class="nc" id="L87">    Throwable cause = null;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">    if (exception != null) {</span>
<span class="nc" id="L89">      cause = exception;</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">      while (cause instanceof ServletException &amp;&amp; cause.getCause() != null) {</span>
<span class="nc" id="L91">        final ServletException servletException = ((ServletException) cause);</span>
<span class="nc" id="L92">        cause = servletException.getCause();</span>
<span class="nc" id="L93">      }</span>
    }
<span class="nc" id="L95">    return cause;</span>
  }

  private static String error(final Optional&lt;Integer&gt; statusOptional) {
    // TODO Optional&lt;Integer&gt;' used as type for parameter
    String result;
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (statusOptional.isPresent()) {</span>
<span class="fc" id="L102">      final Integer status = statusOptional.get();</span>
      try {
<span class="fc" id="L104">        final HttpStatus httpStatus = HttpStatus.valueOf(status);</span>
<span class="fc" id="L105">        result = httpStatus.getReasonPhrase();</span>
<span class="nc" id="L106">      } catch (final IllegalArgumentException ignored) { // Unable to obtain a reason</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L108">          log.debug(&quot;Unable to obtain a reason, status {}&quot;, status, ignored);</span>
        }
<span class="nc" id="L110">        result = &quot;Http Status &quot; + status;</span>
<span class="fc" id="L111">      }</span>
<span class="fc" id="L112">    } else {</span>
<span class="nc" id="L113">      result = &quot;None&quot;;</span>
    }
<span class="fc" id="L115">    return result;</span>
  }

  @Override
  public final ResolvedError resolve( //
    final HttpServletRequest request, //
    final T throwable //
  ) {
<span class="fc" id="L123">    final DateTime now = Defaults.now();</span>

    // See http://stackoverflow.com/a/12979543/2217862
    // This attribute is never set in MockMvc, so it's not covered in integration it.
<span class="fc" id="L127">    request.removeAttribute(PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span>

<span class="fc" id="L129">    final RequestAttributes requestAttributes = new ServletRequestAttributes(request);</span>

<span class="fc" id="L131">    final Boolean stackTrace = this.stackTraceIndicator.stackTrace(request, null);</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">    final String path = request.getQueryString() != null ? //</span>
<span class="pc" id="L133">      request.getRequestURI() + request.getQueryString() : //</span>
<span class="fc" id="L134">      request.getRequestURI();</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">    final String track = stackTrace ? curl(request) : TRACE_OFF;</span>

<span class="fc" id="L137">    return this.resolve(requestAttributes, throwable, now, stackTrace, path, track);</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see ExceptionResolver#resolve(RequestAttributes, Throwable)
   */
  @Override
  public final ResolvedError resolve( //
    final RequestAttributes requestAttributes, //
    final T throwable //
  ) {
<span class="nc" id="L150">    final DateTime now = Defaults.now();</span>

<span class="nc" id="L152">    final Object requestUri = getAttribute( //</span>
      requestAttributes, //
      &quot;javax.servlet.error.request_uri&quot; //
    );
<span class="nc" id="L156">    final Boolean stackTrace = this.stackTraceIndicator.stackTrace(null, null);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">    final String path = requestUri != null ? requestUri.toString() : null;</span>
    // TODO final String track = stackTrace ? curl(request) : TRACE_OFF; ? 忘记为什么这里简单使用requestUri
<span class="nc bnc" id="L159" title="All 2 branches missed.">    final String track = stackTrace ? path : TRACE_OFF;</span>

<span class="nc" id="L161">    return this.resolve(requestAttributes, throwable, now, stackTrace, path, track);</span>
  }

  protected ResolvedError resolve( //
    final RequestAttributes requestAttributes, //
    final T throwable, //
    final DateTime now, //
    final Boolean stackTrace, //
    final String path, //
    final String track //
  ) {
    final ResolvedError resolvedError;
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">    if (isResolvedError(throwable)) {</span>
<span class="nc" id="L174">      resolvedError = ((ResolvedErrorException) throwable).getError();</span>
<span class="nc" id="L175">      resolvedError.trackPrepend(track);</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">    } else if (isResolvedErrorWrapByOther(throwable)) {</span>
      // 注意顺序
      // 1.判断是不是ResolvedErrorException
      // 2.判断是不是被封装了的ResolvedErrorException(如HystrixException)
<span class="nc" id="L180">      log.warn(&quot;这里将被封装过ResolvedErrorException提取出来，原异常信息为：&quot;, throwable);</span>
<span class="nc" id="L181">      resolvedError = ((ResolvedErrorException) throwable.getCause()).getError();</span>
<span class="nc" id="L182">      resolvedError.trackPrepend(track);</span>
    } else {
<span class="fc" id="L184">      final Location location = find(throwable).orElse(null);</span>
      // basic
<span class="fc" id="L186">      final Optional&lt;List&lt;ValidationError&gt;&gt; errorsOptional = this.validationErrors(throwable);</span>
<span class="fc" id="L187">      final Optional&lt;Integer&gt; statusOptional = this.status(requestAttributes, location, throwable);</span>
<span class="fc" id="L188">      final String error = error(statusOptional);</span>
<span class="fc" id="L189">      final List&lt;ValidationError&gt; errors = errorsOptional.orElse(null);</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">      final String exception = throwable != null ? throwable.getClass().getName() : null;</span>
<span class="fc" id="L191">      final String message = message(requestAttributes, throwable, errorsOptional);</span>
<span class="fc" id="L192">      final Integer status = statusOptional.orElse(500);</span>
<span class="fc" id="L193">      final Long timestamp = now.getMillis();</span>
<span class="pc bpc" id="L194" title="3 of 4 branches missed.">      final String trace = stackTrace &amp;&amp; throwable != null ? getStackTraceAsString(throwable) : null;</span>
      // extended
<span class="fc" id="L196">      final String datetime = now.toString(Defaults.ISO8601);</span>
<span class="fc" id="L197">      final String localizedMessage = this.localizedMessage(requestAttributes, location, throwable).orElse(&quot;null&quot;);</span>
<span class="fc" id="L198">      final HttpHeaders headers = this.createHeaders(requestAttributes, throwable).orElse(null);</span>
<span class="fc" id="L199">      final List&lt;String&gt; tracks = ImmutableList.of(track);</span>

<span class="fc" id="L201">      resolvedError = ResolvedError.resolvedErrorBuilder() //</span>
        // basic
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        .error(error) //</span>
<span class="pc" id="L204">        .errors(errors != null ? errors.toArray(new ValidationError[errors.size()]) : null) //</span>
<span class="fc" id="L205">        .exception(exception) //</span>
<span class="fc" id="L206">        .message(message) //</span>
<span class="fc" id="L207">        .path(path) //</span>
<span class="fc" id="L208">        .status(status) //</span>
<span class="fc" id="L209">        .timestamp(timestamp) //</span>
<span class="fc" id="L210">        .trace(trace) //</span>
        // extended
<span class="fc" id="L212">        .datetime(datetime) //</span>
<span class="fc" id="L213">        .localizedMessage(localizedMessage) //</span>
<span class="fc" id="L214">        .headers(HttpHeader.fromHttpHeaders(headers)) //</span>
<span class="fc" id="L215">        .tracks(tracks.toArray(new String[tracks.size()])) //</span>
<span class="fc" id="L216">        .build();</span>
    }

<span class="fc" id="L219">    logError(requestAttributes, throwable, resolvedError);</span>

<span class="fc" id="L221">    return resolvedError;</span>
  }

  /**
   * Logs the exception; on ERROR level when status is 5xx, otherwise on INFO level without stack
   * trace, or DEBUG level with stack trace. The logger name is {@code ExceptionResolver}.
   *
   * @param requestAttributes requestAttributes
   * @param throwable         throwable
   * @param resolvedError     The exception to log.
   */
  protected void logError( //
    final RequestAttributes requestAttributes, //
    final T throwable, //
    final ResolvedError resolvedError //
  ) {
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">    if (resolvedError.getStatus() &gt;= HttpStatus.INTERNAL_SERVER_ERROR.value()) {</span>
<span class="fc" id="L238">      final Marker marker = MarkerFactory.getMarker(&quot;error&quot;);</span>
<span class="fc" id="L239">      final String msg = String.format( //</span>
        &quot;%s ~&gt; %d&quot;, //
<span class="fc" id="L241">        resolvedError.getPath(), //</span>
<span class="fc" id="L242">        resolvedError.getStatus() //</span>
      );

<span class="pc bpc" id="L245" title="1 of 2 branches missed.">      if (log.isTraceEnabled()) {</span>
<span class="nc" id="L246">        log.trace(&quot;attributes in request scope: {}&quot;, //</span>
<span class="nc" id="L247">          newArrayList(requestAttributes.getAttributeNames(SCOPE_REQUEST)));</span>
      }
<span class="fc" id="L249">      log.warn(marker, msg, new Object[]{throwable});</span>
    }
<span class="fc" id="L251">  }</span>

  @SuppressWarnings(&quot;unchecked&quot;)
  private Class&lt;T&gt; determineTargetType() {
<span class="fc" id="L255">    return (Class&lt;T&gt;) GenericTypeResolver.resolveTypeArguments( //</span>
<span class="fc" id="L256">      this.getClass(), //</span>
      AbstractConcreteExceptionResolver.class //
    )[0];
  }

  @Override
  public Class&lt;T&gt; getExceptionClass() {
<span class="nc" id="L263">    return this.exceptionClass;</span>
  }

  @Override
  public void setConversionService(final ConversionService conversionService) {
<span class="fc" id="L268">    this.conversionService = conversionService;</span>
<span class="fc" id="L269">  }</span>

  @Override
  public ExceptionTranslator getExceptionTranslator() {
<span class="fc" id="L273">    return this.exceptionTranslator;</span>
  }

  @Override
  public void setExceptionTranslator(final ExceptionTranslator exceptionTranslator) {
<span class="fc" id="L278">    this.exceptionTranslator = exceptionTranslator;</span>
<span class="fc" id="L279">  }</span>

  @Override
  public void setStackTraceIndicator(final StackTraceIndicator stackTraceIndicator) {
<span class="fc" id="L283">    this.stackTraceIndicator = stackTraceIndicator;</span>
<span class="fc" id="L284">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>