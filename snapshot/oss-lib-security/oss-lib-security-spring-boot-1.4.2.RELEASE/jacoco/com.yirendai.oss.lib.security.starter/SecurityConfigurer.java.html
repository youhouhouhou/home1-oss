<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecurityConfigurer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oss-lib-security-spring-boot-1.4.2.RELEASE</a> &gt; <a href="index.source.html" class="el_package">com.yirendai.oss.lib.security.starter</a> &gt; <span class="el_source">SecurityConfigurer.java</span></div><h1>SecurityConfigurer.java</h1><pre class="source lang-java linenums">package com.yirendai.oss.lib.security.starter;

import com.google.common.collect.Lists;
import com.google.common.primitives.Ints;

import com.fasterxml.jackson.databind.JavaType;
import com.fasterxml.jackson.databind.type.TypeFactory;

import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.builders.WebSecurity;

import java.lang.annotation.Annotation;
import java.lang.reflect.ParameterizedType;
import java.lang.reflect.Type;
import java.util.Comparator;
import java.util.Optional;

/**
 * Created by zhanghaolun on 16/8/30.
 */
public interface SecurityConfigurer&lt;T extends SecurityConfigurer&gt; extends Ordered, Comparable&lt;T&gt; {

<span class="fc" id="L26">  Comparator&lt;SecurityConfigurer&gt; COMPARATOR = (lhs, rhs) -&gt; {</span>
    final int result;
<span class="pc bpc" id="L28" title="2 of 4 branches missed.">    if (lhs != null &amp;&amp; rhs != null) {</span>
<span class="fc" id="L29">      final int lhsOrder = lhs.getOrder();</span>
<span class="fc" id="L30">      final int rhsOrder = rhs.getOrder();</span>
<span class="fc" id="L31">      result = Ints.compare(lhsOrder, rhsOrder);</span>
<span class="pc bnc" id="L32" title="All 2 branches missed.">    } else if (lhs != null) {</span>
<span class="nc" id="L33">      result = -1;</span>
    } else {
<span class="nc" id="L35">      result = 1;</span>
    }
<span class="fc" id="L37">    return result;</span>
  };

  @Override
  default int compareTo(final T rhs) {
<span class="fc" id="L42">    return COMPARATOR.compare(this, rhs);</span>
  }

  /**
   * second invoked.
   *
   * @param auth authentication manager builder
   */
  void configure(AuthenticationManagerBuilder auth);

  /**
   * last invoked.
   *
   * @param http http security builder
   */
  void configure(HttpSecurity http);

  default int getOrder() {
<span class="fc" id="L60">    final Type superClass = this.getClass().getGenericSuperclass();</span>
    final Class&lt;?&gt; clazz;
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">    if (superClass instanceof Class&lt;?&gt;) { // sanity check, should never happen</span>
<span class="nc" id="L63">      clazz = (Class&lt;?&gt;) superClass;</span>
    } else {
<span class="fc" id="L65">      final Type type = ((ParameterizedType) superClass).getActualTypeArguments()[0];</span>

<span class="fc" id="L67">      final JavaType javaType = TypeFactory.defaultInstance().constructType(type);</span>
<span class="fc" id="L68">      clazz = javaType.getRawClass();</span>
    }


<span class="fc" id="L72">    final Annotation[] annotations = clazz.getAnnotations();</span>
<span class="fc" id="L73">    final Optional&lt;Annotation&gt; orderAnnotation = Lists.newArrayList(annotations)</span>
<span class="fc" id="L74">      .stream()</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">      .filter(annotation -&gt; annotation.annotationType() == Order.class)</span>
<span class="fc" id="L76">      .findFirst();</span>

    final int result;
<span class="fc bfc" id="L79" title="All 2 branches covered.">    if (orderAnnotation.isPresent()) {</span>
<span class="fc" id="L80">      final Order order = (Order) orderAnnotation.get();</span>
<span class="fc" id="L81">      result = order.value();</span>
<span class="fc" id="L82">    } else {</span>
<span class="fc" id="L83">      result = LOWEST_PRECEDENCE;</span>
    }
<span class="fc" id="L85">    return result;</span>
  }

  /**
   * first invoked.
   *
   * @param builder web security builder
   */
  void init(WebSecurity builder);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>