<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebSecurityConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oss-configserver</a> &gt; <a href="index.source.html" class="el_package">cn.home1.oss.environment.configserver</a> &gt; <span class="el_source">WebSecurityConfiguration.java</span></div><h1>WebSecurityConfiguration.java</h1><pre class="source lang-java linenums">package cn.home1.oss.environment.configserver;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.collect.Lists.newArrayList;
import static java.lang.Boolean.FALSE;
import static java.util.stream.Collectors.toList;
import static org.springframework.boot.autoconfigure.security.SecurityProperties.ACCESS_OVERRIDE_ORDER;

import com.google.common.collect.Lists;

import com.zaxxer.hikari.HikariDataSource;

import lombok.extern.slf4j.Slf4j;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.security.SecurityProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.authentication.configurers.provisioning.JdbcUserDetailsManagerConfigurer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.builders.WebSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.JdbcUserDetailsManager;
import org.springframework.security.web.authentication.www.BasicAuthenticationFilter;
import org.springframework.transaction.PlatformTransactionManager;

import java.util.List;
import java.util.UUID;

import javax.sql.DataSource;

@Order(ACCESS_OVERRIDE_ORDER)
@Configuration
@EnableWebSecurity
<span class="nc" id="L46">@Slf4j</span>
public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {

  @Value(&quot;${spring.cloud.config.server.prefix:}&quot;)
  private String configServerPrefix;

  @Value(&quot;${spring.cloud.config.server.prefix:}/users/login&quot;)
  private String loginEndpoint;

  @Value(&quot;${management.context-path:}&quot;)
  private String managementContextPath;

  @Value(&quot;${spring.cloud.config.monitor.endpoint.path:}/monitor&quot;)
  private String monitorEndpoint;

  @Value(&quot;${spring.cloud.config.server.monitor.whitelist:}&quot;)
  private String monitorWhitelist;

  private String webhookPassword;

  @Autowired
  private Environment environment;

  @Autowired
  private DataSource dataSource;

  @Autowired
  private JdbcTemplate jdbcTemplate;

  @Autowired
  private SecurityProperties securityProperties;

  @Autowired
  private UserService userService;

<span class="nc" id="L81">  public WebSecurityConfiguration() {</span>
<span class="nc" id="L82">    this.webhookPassword = UUID.randomUUID().toString();</span>
<span class="nc" id="L83">  }</span>

  @Override
  public void init(final WebSecurity web) throws Exception {
<span class="nc bnc" id="L87" title="All 2 branches missed.">    if (this.isH2DataSource()) {</span>
<span class="nc" id="L88">      web.ignoring().antMatchers(&quot;/h2-console/**&quot;, &quot;/index.html&quot;, &quot;/webjars/**&quot;); // see: H2ConsoleSecurityConfigurer</span>
    }
<span class="nc" id="L90">    super.init(web);</span>
<span class="nc" id="L91">  }</span>

  @Override
  protected void configure(final AuthenticationManagerBuilder auth) throws Exception {
<span class="nc" id="L95">    final JdbcUserDetailsManagerConfigurer jdbcAuthentication = auth.jdbcAuthentication();</span>
<span class="nc" id="L96">    jdbcAuthentication.passwordEncoder(this.passwordEncoder());</span>
<span class="nc" id="L97">    jdbcAuthentication.dataSource(this.dataSource);</span>

<span class="nc" id="L99">    final JdbcUserDetailsManager jdbcUserDetailsManager = jdbcAuthentication.getUserDetailsService();</span>
<span class="nc" id="L100">    jdbcUserDetailsManager.setJdbcTemplate(this.jdbcTemplate);</span>
    // setUserCache(new SpringCacheBasedUserCache(new ConcurrentMapCache(SpringCacheBasedUserCache.class.getName())));

<span class="nc" id="L103">    this.createGroups(jdbcAuthentication);</span>
<span class="nc" id="L104">    this.createAdminUser(jdbcAuthentication);</span>
<span class="nc" id="L105">    this.createWebhookUser(jdbcAuthentication);</span>

<span class="nc" id="L107">    this.userService.setPasswordEncoder(this.passwordEncoder());</span>
<span class="nc" id="L108">    this.userService.setUserDetailsManager(jdbcUserDetailsManager);</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">    if (this.isH2DataSource()) {</span>
<span class="nc" id="L111">      final String password = System.getProperty(&quot;defaultPassword&quot;, &quot;user_pass&quot;);</span>

<span class="nc" id="L113">      this.userService.deleteUser(&quot;oss-todomvc-app&quot;, Security.USER_USER, FALSE);</span>
<span class="nc" id="L114">      this.userService.createUser(&quot;oss-todomvc-app&quot;, Security.USER_USER, password);</span>

<span class="nc" id="L116">      this.userService.deleteUser(&quot;oss-todomvc-thymeleaf&quot;, Security.USER_USER, FALSE);</span>
<span class="nc" id="L117">      this.userService.createUser(&quot;oss-todomvc-thymeleaf&quot;, Security.USER_USER, password);</span>

<span class="nc" id="L119">      this.userService.deleteUser(&quot;oss-todomvc-gateway&quot;, Security.USER_USER, FALSE);</span>
<span class="nc" id="L120">      this.userService.createUser(&quot;oss-todomvc-gateway&quot;, Security.USER_USER, password);</span>
    }
<span class="nc" id="L122">  }</span>

  @Override
  protected void configure(final HttpSecurity http) throws Exception {
<span class="nc" id="L126">    http //</span>
<span class="nc" id="L127">        .csrf().disable() //</span>
<span class="nc" id="L128">        .addFilterBefore(this.usernameModifyFilter(), BasicAuthenticationFilter.class) //</span>
<span class="nc" id="L129">        .addFilterBefore(this.monitorWhitelistFilter(), BasicAuthenticationFilter.class) //</span>
<span class="nc" id="L130">        .authorizeRequests() //</span>
<span class="nc" id="L131">        .antMatchers(this.configServerPrefix + &quot;/encrypt&quot;, this.configServerPrefix + this.monitorEndpoint).permitAll()</span>
        //.antMatchers(&quot;/decrypt&quot;).permitAll() //
<span class="nc" id="L133">        .antMatchers(this.configServerPrefix + &quot;/decrypt&quot;).hasRole(Security.ADMIN) //</span>
<span class="nc" id="L134">        .antMatchers(this.configServerPrefix + &quot;/users/login&quot;).permitAll() //</span>
<span class="nc" id="L135">        .antMatchers(this.configServerPrefix + &quot;/users/*&quot;).hasRole(Security.ADMIN) //</span>
<span class="nc" id="L136">        .anyRequest().authenticated() //</span>
<span class="nc" id="L137">        .and() //</span>
<span class="nc" id="L138">        .httpBasic();</span>
<span class="nc" id="L139">  }</span>

  private void createGroups(final JdbcUserDetailsManagerConfigurer jdbcAuthentication) {
<span class="nc" id="L142">    final JdbcUserDetailsManager userDetailsService = jdbcAuthentication.getUserDetailsService();</span>

<span class="nc" id="L144">    final List&lt;String&gt; groups = userDetailsService.findAllGroups();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (!groups.contains(Security.ROLE_ADMIN)) {</span>
<span class="nc" id="L146">      userDetailsService.createGroup(Security.ROLE_ADMIN, //</span>
<span class="nc" id="L147">          newArrayList(new SimpleGrantedAuthority(Security.ROLE_ADMIN)));</span>
    }
<span class="nc bnc" id="L149" title="All 2 branches missed.">    if (!groups.contains(Security.ROLE_USER)) {</span>
<span class="nc" id="L150">      userDetailsService.createGroup(Security.ROLE_USER, //</span>
<span class="nc" id="L151">          newArrayList(new SimpleGrantedAuthority(Security.ROLE_USER)));</span>
    }
<span class="nc bnc" id="L153" title="All 2 branches missed.">    if (!groups.contains(Security.ROLE_WEBHOOK)) {</span>
<span class="nc" id="L154">      userDetailsService.createGroup(Security.ROLE_WEBHOOK, //</span>
<span class="nc" id="L155">          newArrayList(new SimpleGrantedAuthority(Security.ROLE_WEBHOOK)));</span>
    }
<span class="nc" id="L157">  }</span>

  private void createAdminUser(final JdbcUserDetailsManagerConfigurer jdbcAuthentication) {
<span class="nc" id="L160">    final JdbcUserDetailsManager userDetailsService = jdbcAuthentication.getUserDetailsService();</span>

<span class="nc" id="L162">    final String username = this.securityProperties.getUser().getName();</span>
<span class="nc" id="L163">    final String rawPassword = this.securityProperties.getUser().getPassword();</span>
<span class="nc" id="L164">    final List&lt;String&gt; roles = this.securityProperties.getUser().getRole().stream() //</span>
<span class="nc" id="L165">        .sorted().distinct().collect(toList());</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">    checkArgument(!Security.USER_USER.equals(username), //</span>
        &quot;can not use &quot; + Security.USER_USER + &quot; as admin username.&quot;);
<span class="nc bnc" id="L168" title="All 2 branches missed.">    checkArgument(!Security.USER_WEBHOOK.equals(username), //</span>
        &quot;can not use &quot; + Security.USER_WEBHOOK + &quot; as admin username.&quot;);
<span class="nc" id="L170">    checkArgument(roles.contains(Security.ADMIN), //</span>
        &quot;user must has role '&quot; + Security.ADMIN + &quot;'&quot;);

    try {
<span class="nc bnc" id="L174" title="All 2 branches missed.">      for (final String admin : userDetailsService.findUsersInGroup(Security.ROLE_ADMIN)) {</span>
<span class="nc" id="L175">        userDetailsService.removeUserFromGroup(admin, Security.ROLE_ADMIN);</span>
<span class="nc" id="L176">        userDetailsService.deleteUser(admin);</span>
<span class="nc" id="L177">      }</span>
<span class="nc" id="L178">      jdbcAuthentication.getUserDetailsService().deleteUser(username);</span>
<span class="nc" id="L179">      jdbcAuthentication.withUser(username) //</span>
<span class="nc" id="L180">          .password(this.passwordEncoder().encode(rawPassword)) //</span>
<span class="nc" id="L181">          .roles(roles.stream().toArray(String[]::new));</span>
<span class="nc" id="L182">      userDetailsService.addUserToGroup(username, Security.ROLE_ADMIN);</span>
<span class="nc" id="L183">    } catch (final UsernameNotFoundException ex) {</span>
<span class="nc" id="L184">      log.debug(&quot;username '{}' not found&quot;, username, ex);</span>
<span class="nc" id="L185">      jdbcAuthentication.withUser(username) //</span>
<span class="nc" id="L186">          .password(this.passwordEncoder().encode(rawPassword)) //</span>
<span class="nc" id="L187">          .roles(roles.stream().toArray(String[]::new));</span>
<span class="nc" id="L188">      userDetailsService.addUserToGroup(username, Security.ROLE_ADMIN);</span>
<span class="nc" id="L189">    }</span>
<span class="nc" id="L190">  }</span>

  private void createWebhookUser(final JdbcUserDetailsManagerConfigurer jdbcAuthentication) {
<span class="nc" id="L193">    final JdbcUserDetailsManager userDetailsService = jdbcAuthentication.getUserDetailsService();</span>

<span class="nc" id="L195">    final String username = Security.USER_WEBHOOK;</span>
<span class="nc" id="L196">    final String rawPassword = this.webhookPassword;</span>
<span class="nc" id="L197">    final List&lt;String&gt; roles = Lists.newArrayList(Security.WEBHOOK);</span>
    try {
<span class="nc" id="L199">      userDetailsService.removeUserFromGroup(username, Security.ROLE_WEBHOOK);</span>
<span class="nc" id="L200">      userDetailsService.deleteUser(username);</span>
<span class="nc" id="L201">      jdbcAuthentication.withUser(username) //</span>
<span class="nc" id="L202">          .password(this.passwordEncoder().encode(rawPassword)) //</span>
<span class="nc" id="L203">          .roles(roles.stream().toArray(String[]::new));</span>
<span class="nc" id="L204">      userDetailsService.addUserToGroup(username, Security.ROLE_WEBHOOK);</span>
<span class="nc" id="L205">    } catch (final UsernameNotFoundException ex) {</span>
<span class="nc" id="L206">      log.debug(&quot;username '{}' not found&quot;, username, ex);</span>
<span class="nc" id="L207">      jdbcAuthentication.withUser(username) //</span>
<span class="nc" id="L208">          .password(this.passwordEncoder().encode(rawPassword)) //</span>
<span class="nc" id="L209">          .roles(roles.stream().toArray(String[]::new));</span>
<span class="nc" id="L210">      userDetailsService.addUserToGroup(username, Security.ROLE_WEBHOOK);</span>
<span class="nc" id="L211">    }</span>
<span class="nc" id="L212">  }</span>

  @Bean
  public PasswordEncoder passwordEncoder() {
<span class="nc" id="L216">    return new BCryptPasswordEncoder();</span>
  }

  public MonitorWhitelistFilter monitorWhitelistFilter() {
<span class="nc" id="L220">    final MonitorWhitelistFilter filter = new MonitorWhitelistFilter();</span>
<span class="nc" id="L221">    filter.setEnvironment(this.environment);</span>
<span class="nc" id="L222">    filter.setMonitorEndpoint(this.monitorEndpoint);</span>
<span class="nc" id="L223">    filter.setMonitorWhitelist(this.monitorWhitelist);</span>
<span class="nc" id="L224">    filter.setWebhookPassword(this.webhookPassword);</span>
<span class="nc" id="L225">    return filter;</span>
  }

  public UsernameModifyFilter usernameModifyFilter() {
<span class="nc" id="L229">    final UsernameModifyFilter filter = new UsernameModifyFilter();</span>
<span class="nc" id="L230">    filter.setAdminUsername(this.securityProperties.getUser().getName());</span>
<span class="nc" id="L231">    filter.setConfigServerPrefix(this.configServerPrefix);</span>
<span class="nc" id="L232">    filter.setEnvironment(this.environment);</span>
<span class="nc" id="L233">    filter.setLoginEndpoint(this.loginEndpoint);</span>
<span class="nc" id="L234">    filter.setManagementContextPath(this.managementContextPath);</span>
<span class="nc" id="L235">    return filter;</span>
  }

  @Bean
  public PlatformTransactionManager transactionManager() {
<span class="nc" id="L240">    return new DataSourceTransactionManager(this.dataSource);</span>
  }

  private Boolean isH2DataSource() {
<span class="nc" id="L244">    final HikariDataSource hikariDataSource = (HikariDataSource) this.dataSource;</span>
<span class="nc" id="L245">    return &quot;org.h2.Driver&quot;.equals(hikariDataSource.getDriverClassName());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>