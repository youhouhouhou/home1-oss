<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MonitorWhitelistFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oss-configserver</a> &gt; <a href="index.source.html" class="el_package">com.yirendai.oss.environment.configserver</a> &gt; <span class="el_source">MonitorWhitelistFilter.java</span></div><h1>MonitorWhitelistFilter.java</h1><pre class="source lang-java linenums">package com.yirendai.oss.environment.configserver;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.collect.Sets.newHashSet;
import static com.yirendai.oss.lib.common.BasicAuthUtils.BASIC_AUTH_HEADE_NAME;
import static com.yirendai.oss.lib.common.BasicAuthUtils.basicAuthHeader;
import static com.yirendai.oss.lib.common.BasicAuthUtils.extractAndDecodeAuthHeader;
import static java.util.stream.Collectors.toSet;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

import com.google.common.net.InetAddresses;

import lombok.Setter;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;

import org.apache.commons.lang3.StringUtils;
import org.springframework.util.Assert;
import org.springframework.web.filter.GenericFilterBean;

import java.io.IOException;
import java.util.Arrays;
import java.util.Set;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Note: Not a bean, avoid auto pick-up.
 * Created by zhanghaolun on 16/11/2.
 */
<span class="nc bnc" id="L37" title="All 2 branches missed.">@Slf4j</span>
<span class="nc" id="L38">public class MonitorWhitelistFilter extends GenericFilterBean {</span>

<span class="nc" id="L40">  private String credentialsCharset = &quot;UTF-8&quot;;</span>

<span class="nc" id="L42">  @Setter</span>
  private String monitorEndpoint;
<span class="nc" id="L44">  @Setter</span>
  private String webhookPassword;

<span class="nc" id="L47">  private Set&lt;String&gt; monitorWhitelist = newHashSet();</span>

  public void setMonitorWhitelist(final String monitorWhitelist) {
<span class="nc bnc" id="L50" title="All 2 branches missed.">    if (isNotBlank(monitorWhitelist)) {</span>
<span class="nc" id="L51">      this.monitorWhitelist = Arrays.stream(monitorWhitelist.split(&quot;[ ]*,[ ]*&quot;)).collect(toSet());</span>
    } else {
<span class="nc" id="L53">      this.monitorWhitelist = newHashSet();</span>
    }
<span class="nc" id="L55">  }</span>

  @Override
  public void doFilter( //
      final ServletRequest req, //
      final ServletResponse res, //
      final FilterChain chain //
  ) throws IOException, ServletException {
<span class="nc" id="L63">    final HttpServletRequest request = (HttpServletRequest) req;</span>
<span class="nc" id="L64">    final HttpServletResponse response = (HttpServletResponse) res;</span>

<span class="nc" id="L66">    final Boolean isMonitorRequest = this.isMonitorRequest(request);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">    if (isMonitorRequest) {</span>
<span class="nc" id="L68">      final String existingHeader = request.getHeader(BASIC_AUTH_HEADE_NAME);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">      if (existingHeader != null) {</span>
<span class="nc" id="L70">        final String[] tokens = extractAndDecodeAuthHeader(existingHeader, this.getCredentialsCharset(request));</span>
<span class="nc bnc" id="L71" title="All 4 branches missed.">        assert tokens.length == 2;</span>
<span class="nc" id="L72">        final String username = tokens[0];</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L74">          log.trace(&quot;username: {}, password: {}&quot;, username, &quot;*&quot;);</span>
        }
      }
<span class="nc" id="L77">      checkArgument(isBlank(existingHeader), &quot;Basic auth header not allowed: &quot; + existingHeader);</span>

      // see: http://archive.oreilly.com/pub/post/reverse_dns_lookup_and_java.html

<span class="nc" id="L81">      final String remoteAddr = request.getRemoteAddr();</span>
<span class="nc" id="L82">      final String remoteHost = request.getRemoteHost();</span>
<span class="nc bnc" id="L83" title="All 4 branches missed.">      final Boolean inWhiteList = this.isInWhitelist(remoteAddr) || this.isInWhitelist(remoteHost);</span>

<span class="nc" id="L85">      Boolean realIpInWhiteList = true;</span>

      // 判断是否是代理
<span class="nc" id="L88">      String realIp = ProxyIpUtils.getRealIp(req);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">      if (StringUtils.isNotEmpty(realIp)) {</span>
<span class="nc" id="L90">        realIpInWhiteList = this.isInWhitelist(realIp);</span>
      }

<span class="nc bnc" id="L93" title="All 4 branches missed.">      if (inWhiteList &amp;&amp; realIpInWhiteList) {</span>
<span class="nc" id="L94">        log.info(&quot;remoteAddr: {}, remoteHost: {}, realIp: {} in whitelist.&quot;, remoteAddr, remoteHost, realIp);</span>
<span class="nc" id="L95">        final String headerValue = basicAuthHeader(Security.USER_WEBHOOK, this.webhookPassword);</span>
<span class="nc" id="L96">        chain.doFilter(new AuthorizationHeaderWrapper(request, headerValue), response);</span>
<span class="nc" id="L97">      } else {</span>
<span class="nc" id="L98">        log.info(&quot;remoteAddr: {}, remoteHost: {} realIp: {} not in whitelist.&quot;, remoteAddr, remoteHost, realIp);</span>
<span class="nc" id="L99">        chain.doFilter(request, response);</span>
      }
<span class="nc" id="L101">    } else {</span>
<span class="nc" id="L102">      chain.doFilter(request, response);</span>
    }
<span class="nc" id="L104">  }</span>

<span class="nc" id="L106">  @SneakyThrows</span>
  private Boolean isInWhitelist(final String hostIpOrName) {
    final Boolean result;
<span class="nc bnc" id="L109" title="All 2 branches missed.">    if (InetAddresses.isInetAddress(hostIpOrName)) { // ipv4 address</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">      result = this.monitorWhitelist.contains(hostIpOrName) //</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">          || this.monitorWhitelist.contains(ReverseDns.reverseJavaDns(hostIpOrName));</span>
    } else {
<span class="nc" id="L113">      result = this.monitorWhitelist.contains(hostIpOrName);</span>
    }
<span class="nc" id="L115">    return result;</span>
  }

  private Boolean isMonitorRequest(final HttpServletRequest request) {
<span class="nc" id="L119">    final String requestUri = request.getRequestURI();</span>
<span class="nc" id="L120">    return requestUri.startsWith(this.monitorEndpoint);</span>
  }

  public void setCredentialsCharset(final String credentialsCharset) {
<span class="nc" id="L124">    Assert.hasText(credentialsCharset, &quot;credentialsCharset cannot be null or empty&quot;);</span>
<span class="nc" id="L125">    this.credentialsCharset = credentialsCharset;</span>
<span class="nc" id="L126">  }</span>

  protected String getCredentialsCharset(final HttpServletRequest httpRequest) {
<span class="nc bnc" id="L129" title="All 2 branches missed.">    return this.credentialsCharset != null ? this.credentialsCharset : httpRequest.getCharacterEncoding();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>