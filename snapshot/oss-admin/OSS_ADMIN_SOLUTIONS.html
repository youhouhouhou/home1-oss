<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.7.1 at 2017-04-24 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>oss-admin &#x2013; oss-admin开发遇到的问题、解决方案</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                oss-admin
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
          
                <div class="xleft">
        <span id="publishDate">Last Published: 2017-04-24</span>
                  &nbsp;| <span id="projectVersion">Version: 1.0.6.OSS-SNAPSHOT</span>
                      </div>
            <div class="xright">      
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
           
                                <h5>Parent Project</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="oss-build">oss-build</a>
            </li>
          </ul>
                       <h5>DOCUMENTATION</h5>
                  <ul>
                  <li class="none">
                          <a href="README.html" title="README">README</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                 
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>oss-admin&#x5f00;&#x53d1;&#x9047;&#x5230;&#x7684;&#x95ee;&#x9898;&#x3001;&#x89e3;&#x51b3;&#x65b9;&#x6848;</h1>

<div class="section">
<div class="section">
<h3><a name="a"></a><a href="#a">&#x9879;&#x76ee;&#x80cc;&#x666f;</a></h3>

<div class="section">
<h4><a name="admin"></a><a href="#admin">admin&#x7b80;&#x4ecb;</a></h4>

<ol style="list-style-type: decimal">
  
<li>spring boot&#x5e94;&#x7528;&#x7684;&#x63a5;&#x53e3;&#x5927;&#x4f53;&#x5206;&#x4e3a;&#x4e24;&#x7c7b;&#xff0c; &#x4e1a;&#x52a1;&#x63a5;&#x53e3;&#x548c;&#x7ba1;&#x7406;&#x63a5;&#x53e3;&#xff0c;&#x5e76;&#x4e14;&#x6709;&#x5355;&#x72ec;&#x7684;security&#x673a;&#x5236;&#xff0c; &#x7ba1;&#x7406;&#x63a5;&#x53e3;&#x4e3b;&#x8981;&#x7531;actuator&#x6765;&#x63d0;&#x4f9b;&#xff0c;&#x5305;&#x62ec;&#x7cfb;&#x7edf;&#x7684;&#x5065;&#x5eb7;&#x72b6;&#x6001;&#xff0c;&#x73af;&#x5883;&#x53d8;&#x91cf;&#x4fe1;&#x606f;&#xff0c;&#x65e5;&#x5fd7;&#x7ea7;&#x522b;&#x7ba1;&#x7406;&#xff0c;&#x7ebf;&#x7a0b;&#x4fe1;&#x606f;&#xff0c;&#x5806;&#x6808;&#x4fe1;&#x606f;&#x7b49;&#x3002;&#x5bf9;&#x8fd9;&#x4e9b;&#x63a5;&#x53e3;&#x5fc5;&#x987b;&#x8fdb;&#x884c;&#x4e25;&#x683c;&#x7684;&#x6743;&#x9650;&#x63a7;&#x5236;&#xff0c;spring boot&#x901a;&#x5e38;&#x91c7;&#x7528;basic authentication&#x7684;security&#x673a;&#x5236;&#x6765;&#x4fdd;&#x62a4;&#x8fd9;&#x4e9b;&#x63a5;&#x53e3;&#x3002;</li>
  
<li>spring boot admin&#x53ef;&#x4ee5;&#x7406;&#x89e3;&#x6210;&#x4e00;&#x4e2a;spring boot&#x5e94;&#x7528;&#x7ba1;&#x7406;&#x63a5;&#x53e3;&#x7684;&#x4e00;&#x4e2a;UI&#x5e73;&#x53f0;&#xff0c;&#x76f4;&#x63a5;&#x8c03;&#x7528;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x7ba1;&#x7406;&#x63a5;&#x53e3;&#x8fdb;&#x884c;&#x5ba2;&#x6237;&#x7aef;&#x7ba1;&#x7406;&#x3002;&#x8fd9;&#x5c31;&#x8981;&#x6c42;admin&#x5728;&#x8bbf;&#x95ee;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x8fd9;&#x4e9b;&#x7ba1;&#x7406;&#x63a5;&#x53e3;&#x65f6;&#xff0c;&#x6839;&#x636e;&#x4e0d;&#x540c;&#x7684;&#x5ba2;&#x6237;&#x7aef;&#x8bbe;&#x7f6e;&#xff0c;&#x63d0;&#x4f9b;&#x5bf9;&#x5e94;&#x7684;basic auth&#x7684;&#x8ba4;&#x8bc1;&#x4fe1;&#x606f;&#x3002;&#x800c;&#x539f;&#x751f;spring boot admin&#x5e76;&#x4e0d;&#x652f;&#x6301;&#x5ba2;&#x6237;&#x7aef;key&#x7684;&#x83b7;&#x53d6;&#x3002;</li>
  
<li>&#x6211;&#x4eec;&#x901a;&#x8fc7;&#x5f00;&#x53d1;&#x5ba2;&#x6237;&#x7aef;&#x7684;jar&#x5305;&#x7684;&#x65b9;&#x5f0f;&#xff0c;&#x5c06;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x7528;&#x6237;&#x540d;&#x3001;&#x5bc6;&#x7801;&#x8fdb;&#x884c;&#x975e;&#x5bf9;&#x79f0;&#x52a0;&#x5bc6;&#xff0c;&#x901a;&#x8fc7;/info&#x63a5;&#x53e3;&#x53d1;&#x5e03;&#x51fa;&#x53bb;&#xff0c;&#x53ea;&#x6709;admin&#x80fd;&#x591f;&#x5bf9;/info&#x63a5;&#x53e3;&#x4e2d;&#x7684;basic auth&#x4fe1;&#x606f;&#x8fdb;&#x884c;&#x89e3;&#x5bc6;&#x548c;&#x5b58;&#x50a8;&#x3002;</li>
  
<li>admin&#x83b7;&#x53d6;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x7528;&#x6237;&#x540d;&#x3001;&#x5bc6;&#x7801;&#x540e;&#x8fdb;&#x884c;&#x5b58;&#x50a8;&#xff0c;&#x5728;&#x8bbf;&#x95ee;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x7ba1;&#x7406;&#x63a5;&#x53e3;&#x65f6;&#xff0c;&#x901a;&#x8fc7;ZuulFilter&#x63d0;&#x4f9b;&#x7684;&#x62e6;&#x622a;&#x65b9;&#x5f0f;&#xff0c;&#x81ea;&#x52a8;&#x6dfb;&#x52a0;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x8ba4;&#x8bc1;&#x4fe1;&#x606f;&#xff0c;&#x4ece;&#x800c;&#x5b9e;&#x73b0;&#x5bf9;&#x5ba2;&#x6237;&#x7aef;management endpoints&#x7684;&#x8bbf;&#x95ee;&#x3002;</li>
</ol>
</div>
<div class="section">
<h4><a name="admin"></a><a href="#admin">admin&#x5ba2;&#x6237;&#x7aef;&#x5e94;&#x7528;&#x6ce8;&#x518c;&#x903b;&#x8f91;</a></h4>

<ul>
  
<li>admin&#x542f;&#x52a8;&#xff0c;&#x901a;&#x8fc7;<tt>DiscoveryClientConfiguration</tt>&#x521d;&#x59cb;&#x5316;&#x4e00;&#x4e2a;<tt>ApplicationDiscoveryListener</tt>&#xff0c;&#x7528;&#x4e8e;&#x76d1;&#x542c;<tt>InstanceRegisteredEvent</tt>&#xff0c;<tt>HeartbeatEvent</tt>&#x7b49;&#x4e8b;&#x4ef6;&#x3002;</li>
  
<li>&#x5f53;&#x76d1;&#x542c;&#x5230;&#x65b0;&#x7684;&#x5ba2;&#x6237;&#x7aef;&#x4fe1;&#x606f;&#x65f6;&#xff0c;&#x8fdb;&#x884c;admin&#x6ce8;&#x518c;&#xff0c;&#x6ce8;&#x518c;&#x540e;&#x89e6;&#x53d1;&#x4e00;&#x4e2a;<tt>ClientApplicationRegisteredEvent</tt>&#x4e8b;&#x4ef6;&#x3002;</li>
  
<li><tt>StatusUpdateApplicationListener</tt>&#x76d1;&#x542c;&#x5230;&#x8be5;&#x4e8b;&#x4ef6;&#xff0c;&#x8c03;&#x7528;bean <tt>statusUpdater</tt>&#x7684;<tt>updateStatus</tt>&#x65b9;&#x6cd5;&#x8fdb;&#x884c;&#x72b6;&#x6001;&#x66f4;&#x65b0;&#xff0c;&#x8fd9;&#x91cc;&#x4f7f;&#x7528;&#x4ece;eureka&#x83b7;&#x53d6;&#x7684;&#x5ba2;&#x6237;&#x7aef;&#x771f;&#x5b9e;<tt>healthUrl</tt>&#x3002;</li>
  
<li>&#x5b8c;&#x6210;&#x6ce8;&#x518c;</li>
</ul>
</div>
<div class="section">
<h4><a name="a"></a><a href="#a">&#x95ee;&#x9898;</a></h4>

<p>admin&#x5728;&#x83b7;&#x53d6;&#x5ba2;&#x6237;&#x7aef;&#x72b6;&#x6001;&#x65f6;&#x8bbf;&#x95ee;&#x4ece;eureka&#x83b7;&#x53d6;&#x5230;&#x7684;healthUrl&#xff0c;&#x800c;&#x8be5;&#x63a5;&#x53e3;&#x9700;&#x8981;&#x63d0;&#x4f9b;basic auth&#x7684;&#xff0c;&#x56e0;&#x6b64;&#x539f;&#x751f;&#x7cfb;&#x7edf;&#x4e2d;&#x5728;&#x4e0d;&#x6dfb;&#x52a0;&#x4efb;&#x4f55;&#x8ba4;&#x8bc1;&#x4fe1;&#x606f;&#x7684;&#x524d;&#x63d0;&#x4e0b;&#xff0c;health&#x63a5;&#x53e3;&#x8fd4;&#x56de;401&#xff0c; admin&#x7531;&#x4e8e;&#x83b7;&#x53d6;&#x4e0d;&#x5230;&#x5ba2;&#x6237;&#x7aef;&#x7684;&#x771f;&#x5b9e;status&#x4fe1;&#x606f;&#xff0c;&#x9ed8;&#x8ba4;&#x5c06;&#x5ba2;&#x6237;&#x7aef;&#x72b6;&#x6001;&#x5904;&#x7406;&#x4e3a;<tt>DOWN</tt>&#xff0c; &#x8fd9;&#x5c31;&#x662f;admin&#x9996;&#x9875;&#x4e2d;&#x6240;&#x6709;&#x5ba2;&#x6237;&#x7aef;&#x7684;Status&#x90fd;&#x4e3a;<tt>DOWN</tt>&#x7684;&#x539f;&#x56e0;&#x3002;</p>
</div></div>
<div class="section">
<h3><a name="a"></a><a href="#a">&#x89e3;&#x51b3;&#x65b9;&#x6848;</a></h3>

<p>&#x9488;&#x5bf9;&#x8bbf;&#x95ee;health&#x8fd4;&#x56de;401&#x7684;&#x95ee;&#x9898;&#xff0c;&#x5f52;&#x7ed3;&#x4e3a;&#x8bbf;&#x95ee;&#x8be5;&#x63a5;&#x53e3;&#x4e4b;&#x524d;&#xff0c;&#x6dfb;&#x52a0;basic auth&#x4fe1;&#x606f;&#x3002;</p>

<div class="section">
<h4><a name="AOP"></a><a href="#aop">AOP&#x65b9;&#x5f0f;</a></h4>

<p>&#x901a;&#x8fc7;aop&#x5728;&#x8c03;&#x7528;&#x72b6;&#x6001;&#x66f4;&#x65b0;&#x524d;&#xff0c;&#x4fee;&#x6539;listener&#x4e2d;&#x5904;&#x7406;&#x51fd;&#x6570;&#x7684;&#x5165;&#x53c2;&#xff0c;&#x5c06;health url&#x6539;&#x4e3a;&#x8d70;zuul&#x4ee3;&#x7406;&#x7684;&#x65b9;&#x5f0f;&#xff0c;&#x4ece;&#x800c;&#x4f7f;&#x7528;&#x5df2;&#x6709;&#x7684;BasicAuthFilter&#x7c7b;&#x6765;&#x6dfb;&#x52a0;&#x8ba4;&#x8bc1;&#x4fe1;&#x606f;&#xff0c;&#x4f8b;&#x5982;&#x628a;healthUrl&#x4ece;<tt>http://10.106.204.112:8700/health</tt>&#x6539;&#x4e3a;<tt>http://10.106.204.112:8700/api/applications/${serviceId}/health</tt>&#x3002;&#x5177;&#x4f53;&#x6b65;&#x9aa4;&#xff1a;  * &#x5f15;&#x5165;&#x4f9d;&#x8d56;<tt>spring-boot-starter-aop</tt>  * &#x6dfb;&#x52a0;AOP&#x7c7b;&#xff0c;&#x4f7f;&#x7528;&#x6ce8;&#x89e3;<tt>@Component</tt>&#x548c;<tt>@Aspect</tt>  * &#x5b9a;&#x4e49;&#x5207;&#x70b9;&#xff0c;&#x4f7f;&#x7528;&#x6ce8;&#x89e3;<tt>@Pointcut</tt>&#xff0c;&#x5e76;&#x914d;&#x7f6e;&#x5207;&#x70b9;&#x8868;&#x8fbe;&#x5f0f;&#xff0c;&#x6307;&#x5b9a;&#x76ee;&#x6807;&#x7c7b;&#x7684;&#x76ee;&#x6807;&#x65b9;&#x6cd5;  * &#x914d;&#x7f6e;&#x73af;&#x7ed5;&#x901a;&#x77e5;<tt>@Around</tt>&#xff0c;&#x5e76;&#x5b9e;&#x73b0;&#x4fee;&#x6539;&#x76ee;&#x6807;&#x65b9;&#x6cd5;&#x5165;&#x53c2;&#x7684;&#x903b;&#x8f91;</p>
</div>
<div class="section">
<h4><a name="abean"></a><a href="#abean">&#x66ff;&#x6362;bean&#x7684;&#x65b9;&#x5f0f;</a></h4>

<p>&#x4e0d;&#x6539;&#x53d8;health&#x7684;url&#xff0c;&#x76f4;&#x63a5;&#x901a;&#x8fc7;&#x66ff;&#x6362;context&#x73b0;&#x6709;StatusUpdater bean&#xff0c;&#x6539;&#x53d8;updateStatus&#x65b9;&#x6cd5;&#x7684;&#x5b9e;&#x73b0;&#x903b;&#x8f91;&#xff0c;&#x8bf7;&#x6c42;health&#x524d;&#xff0c;&#x6dfb;&#x52a0;&#x8ba4;&#x8bc1;&#x4fe1;&#x606f;&#x3002;&#x5177;&#x4f53;&#x6b65;&#x9aa4;&#xff1a;  * &#x5b9a;&#x4e49;&#x4e00;&#x4e2a;&#x7ee7;&#x627f;&#x81ea;<tt>StatusUpdater</tt>&#x7684;&#x7c7b;  * &#x91cd;&#x5199;<tt>queryStatus</tt>&#x65b9;&#x6cd5;&#xff0c;&#x8bf7;&#x6c42;healthUrl&#x65f6;&#xff0c;&#x4f7f;&#x7528;RestTemplate&#x6dfb;&#x52a0;Basic auth&#x8ba4;&#x8bc1;  * &#x5728;&#x914d;&#x7f6e;&#x7c7b;&#x4e2d;&#x5c06;<tt>PatchedStatusUpdater</tt>&#x58f0;&#x660e;&#x4e3a;<tt>@Primary</tt>&#x7c7b;&#x578b;&#x7684;<tt>StatusUpdater</tt>bean, &#x4ece;&#x800c;&#x53d6;&#x4ee3;&#x539f;&#x6709;&#x7cfb;&#x7edf;&#x4e2d;&#x7684;<tt>StatusUpdater</tt>bean&#x3002;</p>
</div>
<div class="section">
<h4><a name="a"></a><a href="#a">&#x603b;&#x7ed3;</a></h4>

<p>&#x91c7;&#x7528;AOP&#x65b9;&#x5f0f;&#x7531;&#x4e8e;&#x6539;&#x53d8;&#x4e86;&#x76d1;&#x542c;&#x94fe;&#x4e2d;&#x7684;&#x4f20;&#x9012;&#x53c2;&#x6570;&#xff0c;&#x8fdd;&#x53cd;&#x4e86;&#x7f16;&#x7a0b;&#x4e2d;immutablity&#x7684;&#x539f;&#x5219;&#xff0c;&#x5bfc;&#x81f4;admin&#x542f;&#x52a8;&#x540e;&#x7684;&#x5176;&#x4ed6;&#x6570;&#x636e;&#x5f02;&#x5e38;&#xff0c;&#x5f15;&#x5165;&#x66f4;&#x591a;&#x6f5c;&#x5728;&#x7684;bug&#x3002;&#x800c;&#x91c7;&#x7528;&#x66ff;&#x6362;&#x7279;&#x5b9a;bean&#x7684;&#x65b9;&#x6cd5;&#xff0c;&#x80fd;&#x6e05;&#x6670;&#x51c6;&#x786e;&#x5730;&#x5b9a;&#x4f4d;&#x6539;&#x52a8;&#x7684;&#x5f71;&#x54cd;&#x8303;&#x56f4;&#xff0c;&#x4f7f;&#x5f97;&#x5bf9;&#x7cfb;&#x7edf;&#x7684;&#x4fee;&#x6539;&#x66f4;&#x52a0;&#x73af;&#x4fdd;&#x3002;&#x56e0;&#x6b64;&#x89e3;&#x51b3;&#x8be5;&#x95ee;&#x9898;&#x91c7;&#x7528;&#x4e86;&#x540e;&#x4e00;&#x79cd;&#x65b9;&#x5f0f;&#x3002;</p>
</div></div>
<div class="section">
<h3><a name="a"></a><a href="#a">&#x4ee3;&#x7801;&#x793a;&#x4f8b;</a></h3>

<div class="section">
<h4><a name="aop"></a><a href="#aop">aop&#x65b9;&#x6848;</a></h4>

<p><tt>StatusUpdateAspect</tt>&#x5207;&#x9762;&#x7684;&#x5b9a;&#x4e49;</p>

<div class="source">
<div class="source">
<pre>@Component
@Order(5)
@Aspect
public class StatusUpdateAspect {
  @Pointcut(&quot;execution(* de.codecentric.boot.admin.registry.StatusUpdateApplicationListener.onClientApplicationRegistered(de.codecentric.boot.admin.event.ClientApplicationRegisteredEvent))&quot;)
  public void updateStatus() {
  }

  @Before(&quot;updateStatus()&quot;)
  public void onClientApplicationRegistered(JoinPoint joinPoint) {
    LOGGER.info(&quot;Begin to update application status.&quot;);
  }

  @Around(&quot;updateStatus()&quot;)
  public Object processEvent(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
    ClientApplicationRegisteredEvent clientApplicationRegisteredEvent = (ClientApplicationRegisteredEvent) proceedingJoinPoint.getArgs()[0];
    Application application = clientApplicationRegisteredEvent.getApplication();
    Application.Builder builder = Application.create(application.getName()).withId(application.getId());

    builder.withManagementUrl(application.getManagementUrl())
           .withServiceUrl(application.getServiceUrl())
           .withStatusInfo(application.getStatusInfo())
           .withHealthUrl(getHealthUrl(application));
    Application transformedApplication = builder.build();
    ClientApplicationRegisteredEvent transformedClientApplicationRegisteredEvent = new ClientApplicationRegisteredEvent
        (transformedApplication);
    return proceedingJoinPoint.proceed(new Object[]{transformedClientApplicationRegisteredEvent});
  }
}```
#### &#x66ff;&#x6362;&#x5bb9;&#x5668;&#x4e2d;bean&#x65b9;&#x6cd5;&#x7684;&#x5177;&#x4f53;&#x903b;&#x8f91;
&#x5b9a;&#x4e49;`StatusUpdater`&#x7684;&#x5b50;&#x7c7b;&#xff0c;&#x91cd;&#x5199;`updateStatus`&#x65b9;&#x6cd5;
</pre></div></div>

<p>public class PatchedStatusUpdater extends StatusUpdater{  private boolean active = false;</p>

<p>private final ApplicationStore store;</p>

<p>private ApplicationEventPublisher publisher;</p>

<p>private final RestTemplate restTemplate;</p>

<p>@Autowired  private ClientKeyStore clientKeyStore;</p>

<p>@Autowired  private BasicAuthFilter basicAuthFilter;</p>

<p>public PatchedStatusUpdater(RestTemplate restTemplate, ApplicationStore store) {  super(restTemplate, store);  this.restTemplate = restTemplate;  this.store = store;  }</p>

<p>@Override  public void updateStatus(Application application) {</p>

<div class="source">
<div class="source">
<pre>if (active) {
  StatusInfo oldStatus = application.getStatusInfo();
  StatusInfo newStatus = queryStatus(application);

  Application newState = Application.create(application).withStatusInfo(newStatus).build();
  store.save(newState);

  if (!newStatus.equals(oldStatus)) {
    publisher.publishEvent(
        new ClientApplicationStatusChangedEvent(newState, oldStatus, newStatus));
  }
} else {
  log.info(&quot;Application not started yet. Application update process not executed&quot;);
}
</pre></div></div>

<p>}<tt>
&#x5728;&#x4e3b;&#x914d;&#x7f6e;&#x7c7b;&#x4e2d;&#x58f0;&#x660e;`StatusUpdater` bean
</tt> @Primary @Bean @ConditionalOnMissingBean public StatusUpdater statusUpdater() {  RestTemplate template = new RestTemplate();  template.getMessageConverters().add(new MappingJackson2HttpMessageConverter());  template.setErrorHandler(new DefaultResponseErrorHandler() {  @Override  protected boolean hasError(HttpStatus statusCode) {  return false;  }  });  StatusUpdater statusUpdater = new PatchedStatusUpdater(template, applicationStore);  statusUpdater.setStatusLifetime(adminServerProperties.getMonitor().getStatusLifetime());</p>

<p>return statusUpdater; } ```</p></div></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2017.
          All rights reserved.    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
